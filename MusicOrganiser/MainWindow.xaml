<Window x:Class="MusicOrganiser.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:MusicOrganiser.Converters"
        mc:Ignorable="d"
        Title="Music Organiser" Height="700" Width="1200"
        WindowStartupLocation="CenterScreen"
        Icon="logo.ico">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:NowPlayingConverter x:Key="NowPlayingConverter"/>
        <converters:NowPlayingBoolConverter x:Key="NowPlayingBoolConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:NullToBoolConverter x:Key="NullToBoolConverter"/>

        <Style x:Key="PlayerButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Margin" Value="5,0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="200" MaxWidth="400"/>
            <ColumnDefinition Width="3"/>
            <ColumnDefinition Width="3*"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Folder Tree with Filter -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TreeView x:Name="FolderTreeView" Grid.Row="0"
                      ItemsSource="{Binding FolderTree.RootNodes}"
                      SelectedItemChanged="FolderTreeView_SelectedItemChanged"
                      VirtualizingStackPanel.IsVirtualizing="True"
                      VirtualizingStackPanel.VirtualizationMode="Recycling">
                <TreeView.ItemContainerStyle>
                    <Style TargetType="TreeViewItem">
                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                        <Setter Property="Visibility" Value="{Binding IsVisible, Converter={StaticResource BoolToVis}}"/>
                        <EventSetter Event="MouseRightButtonDown" Handler="TreeViewItem_MouseRightButtonDown"/>
                    </Style>
                </TreeView.ItemContainerStyle>
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                        <TextBlock Text="{Binding Name}" Padding="2">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsDeleted}" Value="True">
                                            <Setter Property="Foreground" Value="Gray"/>
                                            <Setter Property="TextDecorations" Value="Strikethrough"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
                <TreeView.ContextMenu>
                    <ContextMenu x:Name="FolderContextMenu" Opened="FolderContextMenu_Opened">
                        <MenuItem x:Name="FolderCopyToMenu" Header="Copy To">
                            <MenuItem Header="Browse..." Click="FolderCopyBrowse_Click"/>
                        </MenuItem>
                        <MenuItem x:Name="FolderMoveToMenu" Header="Move To">
                            <MenuItem Header="Browse..." Click="FolderMoveBrowse_Click"/>
                        </MenuItem>
                        <Separator/>
                        <MenuItem Header="Delete" Click="FolderDelete_Click"/>
                    </ContextMenu>
                </TreeView.ContextMenu>
            </TreeView>

            <!-- Filter and Sort Panel -->
            <Border Grid.Row="1" Background="#F0F0F0" BorderBrush="#CCCCCC" BorderThickness="0,1,0,0" Padding="5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBox Grid.Row="0"
                             Text="{Binding FolderTree.FilterText, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="Filter folders"
                             Margin="0,0,0,5"/>
                    <ComboBox Grid.Row="1"
                              ItemsSource="{Binding FolderTree.SortOptions}"
                              SelectedItem="{Binding FolderTree.SelectedSortOption}"
                              ToolTip="Sort folders by"/>
                </Grid>
            </Border>
        </Grid>

        <!-- Splitter -->
        <GridSplitter Grid.Column="1" Width="3" HorizontalAlignment="Stretch" Background="LightGray"/>

        <!-- Right Panel: Music Grid + Player -->
        <Grid Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="4*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Music Files Grid -->
            <DataGrid x:Name="MusicFilesGrid" Grid.Row="0"
                      ItemsSource="{Binding MusicFiles}"
                      SelectedItem="{Binding SelectedFile}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Extended"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      GridLinesVisibility="None"
                      AlternationCount="2"
                      MouseDoubleClick="MusicFilesGrid_MouseDoubleClick">
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Setter Property="Background">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource NowPlayingConverter}">
                                    <Binding />
                                    <Binding Path="DataContext.NowPlaying" RelativeSource="{RelativeSource AncestorType=DataGrid}"/>
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <Trigger Property="AlternationIndex" Value="1">
                                <Setter Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                            <DataTrigger Value="True">
                                <DataTrigger.Binding>
                                    <MultiBinding Converter="{StaticResource NowPlayingBoolConverter}">
                                        <Binding />
                                        <Binding Path="DataContext.NowPlaying" RelativeSource="{RelativeSource AncestorType=DataGrid}"/>
                                    </MultiBinding>
                                </DataTrigger.Binding>
                                <Setter Property="Background" Value="#C8E6FF"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="File Name" Binding="{Binding FileName}" Width="*" MinWidth="150"/>
                    <DataGridTextColumn Header="Title" Binding="{Binding Title}" Width="*" MinWidth="100"/>
                    <DataGridTextColumn Header="Artist" Binding="{Binding Artist}" Width="*" MinWidth="100"/>
                    <DataGridTextColumn Header="Album" Binding="{Binding Album}" Width="*" MinWidth="100"/>
                    <DataGridTextColumn Header="Duration" Binding="{Binding DurationFormatted}" Width="70"/>
                    <DataGridTextColumn Header="Bitrate" Binding="{Binding BitrateFormatted}" Width="80"/>
                    <DataGridTextColumn Header="Genre" Binding="{Binding Genre}" Width="80"/>
                    <DataGridTextColumn Header="Year" Binding="{Binding Year}" Width="50"/>
                </DataGrid.Columns>
                <DataGrid.ContextMenu>
                    <ContextMenu x:Name="FileContextMenu" Opened="FileContextMenu_Opened">
                        <MenuItem x:Name="FileCopyToMenu" Header="Copy To">
                            <MenuItem Header="Browse..." Click="FileCopyBrowse_Click"/>
                        </MenuItem>
                        <MenuItem x:Name="FileMoveToMenu" Header="Move To">
                            <MenuItem Header="Browse..." Click="FileMoveBrowse_Click"/>
                        </MenuItem>
                        <Separator/>
                        <MenuItem Header="Delete" Click="FileDelete_Click"/>
                    </ContextMenu>
                </DataGrid.ContextMenu>
            </DataGrid>

            <!-- Audio Player Control -->
            <Border Grid.Row="1" Background="#F0F0F0" BorderBrush="#CCCCCC" BorderThickness="0,1,0,0" Padding="10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="7*"/>
                        <ColumnDefinition Width="3*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Player Controls (70%) -->
                    <Grid Grid.Column="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Now Playing Info -->
                        <TextBlock Grid.Row="0"
                                   Text="{Binding NowPlaying.FileName, FallbackValue='No file playing'}"
                                   FontSize="14" FontWeight="SemiBold"
                                   TextTrimming="CharacterEllipsis"
                                   Margin="0,0,10,5"/>

                        <!-- Progress Slider -->
                        <Grid Grid.Row="1" Margin="0,5,10,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="50"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="50"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding CurrentPositionFormatted}" VerticalAlignment="Center"/>
                            <ProgressBar Grid.Column="1"
                                    x:Name="ProgressBar"
                                    Minimum="0" Maximum="100"
                                    Value="{Binding SliderValue, Mode=OneWay}"
                                    Margin="10,0"
                                    Height="20"
                                    Cursor="Hand"
                                    MouseLeftButtonDown="ProgressBar_MouseLeftButtonDown"/>
                            <TextBlock Grid.Column="2" Text="{Binding TotalDurationFormatted}" VerticalAlignment="Center" HorizontalAlignment="Right"/>
                        </Grid>

                        <!-- Control Buttons and Volume -->
                        <Grid Grid.Row="2" Margin="0,10,10,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                                <Button Content="&#9198;" Style="{StaticResource PlayerButtonStyle}"
                                        Command="{Binding PreviousCommand}" ToolTip="Previous"/>
                                <Button Style="{StaticResource PlayerButtonStyle}"
                                        Command="{Binding PlayPauseCommand}" ToolTip="Play/Pause">
                                    <Button.Content>
                                        <TextBlock>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="&#9654;"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                                            <Setter Property="Text" Value="&#10074;&#10074;"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Button.Content>
                                </Button>
                                <Button Content="&#9632;" Style="{StaticResource PlayerButtonStyle}"
                                        Command="{Binding StopCommand}" ToolTip="Stop"/>
                                <Button Content="&#9197;" Style="{StaticResource PlayerButtonStyle}"
                                        Command="{Binding NextCommand}" ToolTip="Next"/>
                            </StackPanel>

                            <!-- Volume Control -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                <TextBlock Text="&#128266;" FontSize="16" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <ProgressBar x:Name="VolumeBar"
                                             Width="80" Height="20"
                                             Minimum="0" Maximum="100"
                                             Value="{Binding Volume, Mode=OneWay}"
                                             Cursor="Hand"
                                             ToolTip="Volume"
                                             MouseLeftButtonDown="VolumeBar_MouseLeftButtonDown"/>
                            </StackPanel>
                        </Grid>
                    </Grid>

                    <!-- Right: AI Artist Summary (30%) -->
                    <Border Grid.Column="1" BorderBrush="#CCCCCC" BorderThickness="1,0,0,0" Padding="10,0,0,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Header with refresh button -->
                            <Grid Grid.Row="0" Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Artist Info" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                <Button Grid.Column="1" Content="&#8635;" FontSize="14" Padding="5,2"
                                        Command="{Binding RefreshArtistInfoCommand}"
                                        ToolTip="Refresh artist info"
                                        IsEnabled="{Binding NowPlaying, Converter={StaticResource NullToBoolConverter}}"/>
                            </Grid>

                            <TextBlock Grid.Row="1"
                                       Text="{Binding ArtistSummary, FallbackValue='Select a track to see artist info'}"
                                       FontSize="11"
                                       Foreground="#555555"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Top"/>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
